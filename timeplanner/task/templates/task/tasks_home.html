{% extends "base.html" %}
{% load static i18n %}

{% block content %}
  {{ block.super }}

  <div class="btn-toolbar mb-3 disabled" role="toolbar" aria-label="Toolbar with button groups">
    <div class="btn-group mr-2" role="group" aria-label="First group">
      <button type="button" class="btn btn-secondary">1</button>
      <button type="button" class="btn btn-secondary">2</button>
      <button type="button" class="btn btn-secondary">3</button>
      <button type="button" class="btn btn-secondary">4</button>
    </div>
    <div class="btn-group mr-2" role="group" aria-label="Second group">
      <button type="button" id="left" class="btn btn-secondary direction"><i class="fas fa-long-arrow-left"></i>
      </button>
      <button type="button" id="right" class="btn btn-secondary direction"><i class="fas fa-long-arrow-right"></i>
      </button>
    </div>
    <div class="btn-group mr-2" role="group" aria-label="Second group">
      <button type="button" id="up" class="btn btn-secondary direction"><i class="fas fa-long-arrow-up"></i></button>
      <button type="button" id="down" class="btn btn-secondary direction"><i class="fas fa-long-arrow-down"></i>
      </button>
    </div>
    <div class="btn-group" role="group" aria-label="Third group">
      <button type="button" class="btn btn-secondary">8</button>
    </div>
  </div>

  {% for node in expanded_tasks %}

    <div class="list-group task">
      {% include 'task/components/tasknode.html' with node=node %}
    </div>

  {% empty %}
    No tasks!
  {% endfor %}

{% endblock content %}



{% block javascript %}
  {{ block.super }}
  <script src="{% static 'js/sortable.min.js' %}" crossorigin="anonymous"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/12.1.0/inline/ckeditor.js"></script>
  <script>
    var selected = undefined;
    document.addEventListener("DOMContentLoaded", function (event) {
      $('.selectable').click(function () {
        var item = $(this);
        if (item.hasClass('selected')) {
          $(item).removeClass('selected');
          selected = undefined;
        } else {
          $(selected).removeClass('selected');
          $(item).addClass('selected');
          selected = item;
        }
        return false;
      })
    })
  </script>

  <script>

    document.addEventListener("DOMContentLoaded", function (event) {
      $('.direction').click(function(){
        if(!selected) return;
        var direction = $(this).attr('id');
         $.ajax({
              url: '',
              data: {
                'command': 'move',
                'target': $(selected).attr('id').replace('#node_', ''),
                'direction': direction,
              },
              dataType: 'json',
              fail: function () {
                alert('Fail, reverting order');
                this.sort(this._currentOrder);
              },
              always: function () {
                sorter.el.classList.remove('pulsate');
              }
            });
      })

    });

  </script>


  <script>

    document.addEventListener("DOMContentLoaded", function (event) {

      var nestedSortables = [].slice.call(document.querySelectorAll('.task'));

      // Loop through each nested sortable element
      for (var i = 0; i < nestedSortables.length; i++) {
        new Sortable(nestedSortables[i], {
          group: 'nested',
          animation: 150,
          fallbackOnBody: true,
          handle: '.handle',
          swapThreshold: 0.65,
          multiDrag: false, //explore later https://github.com/SortableJS/Sortable/wiki/Dragging-Multiple-Items-in-Sortable
          selectedClass: '',
          onStart: function () {
            // Save order before sort
            this._currentOrder = this.toArray();

          },
          onEnd: function (e) {
            this.el.classList.add('pulsate');
            var target_id = '#' + e.item.id;
            var target_parent = $(target_id).parent().parent();
            var target_prev_sibling = $(target_id).prev();

            var target_parent_id = target_parent.attr('id');
            var target_prev_sibling_id = target_prev_sibling.attr('id');

            if (target_parent_id) target_parent_id = target_parent_id.replace('node_', '');
            if (target_prev_sibling_id) target_prev_sibling_id = target_prev_sibling_id.replace('node_', '');

            let sorter = this;


            $.ajax({
              url: '',
              data: {
                'command': 'update',
                'target': target_id.replace('#node_', ''),
                'parent': target_parent_id,
                'prev_sibling': target_prev_sibling_id
              },
              dataType: 'json',
              fail: function () {
                alert('Fail, reverting order');
                this.sort(this._currentOrder);
              },
              always: function () {
                sorter.el.classList.remove('pulsate');
              }
            });

          }
        });
      }
    });
  </script>

  <script>


  </script>
{% endblock %}
